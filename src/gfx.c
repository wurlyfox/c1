#include "globals.h"
#include "ns.h"
#include "math.h"
#include "slst.h"
#include "level.h"

#include "formats/svtx.h"
#include "formats/cvtx.h"
#include "formats/tgeo.h"
#include "formats/wgeo.h"
#include "formats/slst.h"

static inline void GfxFillMatrix(mat16 *m, uint16_t val) {
  m->m[0][0]=val;m->m[0][1]=val;m->m[0][2]=val;
  m->m[1][0]=val;m->m[1][1]=val;m->m[1][2]=val;
  m->m[2][0]=val;m->m[2][1]=val;m->m[2][2]=val;
}

static inline void GfxCopyMatrix(mat16 *m_s, mat16 *m_d) {
  int i;
  for (i=0;i<9;i++)
    ((uint16_t*)((m_d)->m))[i]=((uint16_t*)((m_s)->m))[i];
}

#ifdef PSX
#define setPolyFT4C(p,c)	setlen(p, 9),  setcode(p, c)
#else
#include "pc/gfx/pcgfx.h"
#include "pc/gfx/soft.h"
#include "pc/gfx/tex.h"
#include "pc/gfx/gl.h"
extern sw_transform_struct params;

static rgb Rgb8To32(rgb8 c) {
  rgb res;
  res.r = c.r*16843009;
  res.g = c.g*16843009;
  res.b = c.b*16843009;
  return res;
}

static rgba Rgb8ToA32(rgb8 c) {
  rgba res;
  res.r = c.r*16843009;
  res.g = c.g*16843009;
  res.b = c.b*16843009;
  res.a = ~0;
  return res;
}
#endif

/* .data */
const vec v_zero = { 0, 0, 0 };
const quad28_t uv_map[600] = {
  { {  0,  0 }, {  3,  0 }, {  0,  3 }, {  3,  3 } },
  { {  0,  0 }, {  7,  0 }, {  0,  3 }, {  7,  3 } },
  { {  0,  0 }, { 15,  0 }, {  0,  3 }, { 15,  3 } },
  { {  0,  0 }, { 31,  0 }, {  0,  3 }, { 31,  3 } },
  { {  0,  0 }, { 63,  0 }, {  0,  3 }, { 63,  3 } },
  { {  0,  0 }, {  3,  0 }, {  0,  7 }, {  3,  7 } },
  { {  0,  0 }, {  7,  0 }, {  0,  7 }, {  7,  7 } },
  { {  0,  0 }, { 15,  0 }, {  0,  7 }, { 15,  7 } },
  { {  0,  0 }, { 31,  0 }, {  0,  7 }, { 31,  7 } },
  { {  0,  0 }, { 63,  0 }, {  0,  7 }, { 63,  7 } },
  { {  0,  0 }, {  3,  0 }, {  0, 15 }, {  3, 15 } },
  { {  0,  0 }, {  7,  0 }, {  0, 15 }, {  7, 15 } },
  { {  0,  0 }, { 15,  0 }, {  0, 15 }, { 15, 15 } },
  { {  0,  0 }, { 31,  0 }, {  0, 15 }, { 31, 15 } },
  { {  0,  0 }, { 63,  0 }, {  0, 15 }, { 63, 15 } },
  { {  0,  0 }, {  3,  0 }, {  0, 31 }, {  3, 31 } },
  { {  0,  0 }, {  7,  0 }, {  0, 31 }, {  7, 31 } },
  { {  0,  0 }, { 15,  0 }, {  0, 31 }, { 15, 31 } },
  { {  0,  0 }, { 31,  0 }, {  0, 31 }, { 31, 31 } },
  { {  0,  0 }, { 63,  0 }, {  0, 31 }, { 63, 31 } },
  { {  0,  0 }, {  3,  0 }, {  0, 63 }, {  3, 63 } },
  { {  0,  0 }, {  7,  0 }, {  0, 63 }, {  7, 63 } },
  { {  0,  0 }, { 15,  0 }, {  0, 63 }, { 15, 63 } },
  { {  0,  0 }, { 31,  0 }, {  0, 63 }, { 31, 63 } },
  { {  0,  0 }, { 63,  0 }, {  0, 63 }, { 63, 63 } },
  { {  0,  0 }, {  0,  3 }, {  3,  0 }, {  3,  3 } },
  { {  0,  0 }, {  0,  3 }, {  7,  0 }, {  7,  3 } },
  { {  0,  0 }, {  0,  3 }, { 15,  0 }, { 15,  3 } },
  { {  0,  0 }, {  0,  3 }, { 31,  0 }, { 31,  3 } },
  { {  0,  0 }, {  0,  3 }, { 63,  0 }, { 63,  3 } },
  { {  0,  0 }, {  0,  7 }, {  3,  0 }, {  3,  7 } },
  { {  0,  0 }, {  0,  7 }, {  7,  0 }, {  7,  7 } },
  { {  0,  0 }, {  0,  7 }, { 15,  0 }, { 15,  7 } },
  { {  0,  0 }, {  0,  7 }, { 31,  0 }, { 31,  7 } },
  { {  0,  0 }, {  0,  7 }, { 63,  0 }, { 63,  7 } },
  { {  0,  0 }, {  0, 15 }, {  3,  0 }, {  3, 15 } },
  { {  0,  0 }, {  0, 15 }, {  7,  0 }, {  7, 15 } },
  { {  0,  0 }, {  0, 15 }, { 15,  0 }, { 15, 15 } },
  { {  0,  0 }, {  0, 15 }, { 31,  0 }, { 31, 15 } },
  { {  0,  0 }, {  0, 15 }, { 63,  0 }, { 63, 15 } },
  { {  0,  0 }, {  0, 31 }, {  3,  0 }, {  3, 31 } },
  { {  0,  0 }, {  0, 31 }, {  7,  0 }, {  7, 31 } },
  { {  0,  0 }, {  0, 31 }, { 15,  0 }, { 15, 31 } },
  { {  0,  0 }, {  0, 31 }, { 31,  0 }, { 31, 31 } },
  { {  0,  0 }, {  0, 31 }, { 63,  0 }, { 63, 31 } },
  { {  0,  0 }, {  0, 63 }, {  3,  0 }, {  3, 63 } },
  { {  0,  0 }, {  0, 63 }, {  7,  0 }, {  7, 63 } },
  { {  0,  0 }, {  0, 63 }, { 15,  0 }, { 15, 63 } },
  { {  0,  0 }, {  0, 63 }, { 31,  0 }, { 31, 63 } },
  { {  0,  0 }, {  0, 63 }, { 63,  0 }, { 63, 63 } },
  { {  3,  0 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { {  7,  0 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { { 15,  0 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { { 31,  0 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { { 63,  0 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { {  3,  0 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { {  7,  0 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { { 15,  0 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { { 31,  0 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { { 63,  0 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { {  3,  0 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { {  7,  0 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { { 15,  0 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { { 31,  0 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { { 63,  0 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { {  3,  0 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { {  7,  0 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { { 15,  0 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { { 31,  0 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { { 63,  0 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { {  3,  0 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { {  7,  0 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { { 15,  0 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { { 31,  0 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { { 63,  0 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { {  3,  0 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { {  7,  0 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { { 15,  0 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { { 31,  0 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { { 63,  0 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { {  3,  0 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { {  7,  0 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { { 15,  0 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { { 31,  0 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { { 63,  0 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { {  3,  0 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { {  7,  0 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { { 15,  0 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { { 31,  0 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { { 63,  0 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { {  3,  0 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { {  7,  0 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { { 15,  0 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { { 31,  0 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { { 63,  0 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { {  3,  0 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { {  7,  0 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { { 15,  0 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { { 31,  0 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { { 63,  0 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { {  0,  3 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  0,  3 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { {  0,  3 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { {  0,  3 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { {  0,  3 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  0,  7 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  0,  7 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { {  0,  7 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { {  0,  7 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { {  0,  7 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  0, 15 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  0, 15 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { {  0, 15 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { {  0, 15 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { {  0, 15 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  0, 31 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  0, 31 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { {  0, 31 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { {  0, 31 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { {  0, 31 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  0, 63 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  0, 63 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { {  0, 63 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { {  0, 63 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { {  0, 63 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  0,  3 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  3 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  3 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  3 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  3 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  7 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  7 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  7 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  7 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  7 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 15 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 15 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 15 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 15 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 15 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 31 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 31 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 31 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 31 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 31 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 63 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 63 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 63 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 63 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0, 63 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  0,  0 }, {  3,  0 }, {  3,  3 }, { 99, 99 } },
  { {  0,  0 }, {  7,  0 }, {  7,  3 }, { 99, 99 } },
  { {  0,  0 }, { 15,  0 }, { 15,  3 }, { 99, 99 } },
  { {  0,  0 }, { 31,  0 }, { 31,  3 }, { 99, 99 } },
  { {  0,  0 }, { 63,  0 }, { 63,  3 }, { 99, 99 } },
  { {  0,  0 }, {  3,  0 }, {  3,  7 }, { 99, 99 } },
  { {  0,  0 }, {  7,  0 }, {  7,  7 }, { 99, 99 } },
  { {  0,  0 }, { 15,  0 }, { 15,  7 }, { 99, 99 } },
  { {  0,  0 }, { 31,  0 }, { 31,  7 }, { 99, 99 } },
  { {  0,  0 }, { 63,  0 }, { 63,  7 }, { 99, 99 } },
  { {  0,  0 }, {  3,  0 }, {  3, 15 }, { 99, 99 } },
  { {  0,  0 }, {  7,  0 }, {  7, 15 }, { 99, 99 } },
  { {  0,  0 }, { 15,  0 }, { 15, 15 }, { 99, 99 } },
  { {  0,  0 }, { 31,  0 }, { 31, 15 }, { 99, 99 } },
  { {  0,  0 }, { 63,  0 }, { 63, 15 }, { 99, 99 } },
  { {  0,  0 }, {  3,  0 }, {  3, 31 }, { 99, 99 } },
  { {  0,  0 }, {  7,  0 }, {  7, 31 }, { 99, 99 } },
  { {  0,  0 }, { 15,  0 }, { 15, 31 }, { 99, 99 } },
  { {  0,  0 }, { 31,  0 }, { 31, 31 }, { 99, 99 } },
  { {  0,  0 }, { 63,  0 }, { 63, 31 }, { 99, 99 } },
  { {  0,  0 }, {  3,  0 }, {  3, 63 }, { 99, 99 } },
  { {  0,  0 }, {  7,  0 }, {  7, 63 }, { 99, 99 } },
  { {  0,  0 }, { 15,  0 }, { 15, 63 }, { 99, 99 } },
  { {  0,  0 }, { 31,  0 }, { 31, 63 }, { 99, 99 } },
  { {  0,  0 }, { 63,  0 }, { 63, 63 }, { 99, 99 } },
  { {  0,  0 }, {  3,  3 }, {  3,  0 }, { 99, 99 } },
  { {  0,  0 }, {  7,  3 }, {  7,  0 }, { 99, 99 } },
  { {  0,  0 }, { 15,  3 }, { 15,  0 }, { 99, 99 } },
  { {  0,  0 }, { 31,  3 }, { 31,  0 }, { 99, 99 } },
  { {  0,  0 }, { 63,  3 }, { 63,  0 }, { 99, 99 } },
  { {  0,  0 }, {  3,  7 }, {  3,  0 }, { 99, 99 } },
  { {  0,  0 }, {  7,  7 }, {  7,  0 }, { 99, 99 } },
  { {  0,  0 }, { 15,  7 }, { 15,  0 }, { 99, 99 } },
  { {  0,  0 }, { 31,  7 }, { 31,  0 }, { 99, 99 } },
  { {  0,  0 }, { 63,  7 }, { 63,  0 }, { 99, 99 } },
  { {  0,  0 }, {  3, 15 }, {  3,  0 }, { 99, 99 } },
  { {  0,  0 }, {  7, 15 }, {  7,  0 }, { 99, 99 } },
  { {  0,  0 }, { 15, 15 }, { 15,  0 }, { 99, 99 } },
  { {  0,  0 }, { 31, 15 }, { 31,  0 }, { 99, 99 } },
  { {  0,  0 }, { 63, 15 }, { 63,  0 }, { 99, 99 } },
  { {  0,  0 }, {  3, 31 }, {  3,  0 }, { 99, 99 } },
  { {  0,  0 }, {  7, 31 }, {  7,  0 }, { 99, 99 } },
  { {  0,  0 }, { 15, 31 }, { 15,  0 }, { 99, 99 } },
  { {  0,  0 }, { 31, 31 }, { 31,  0 }, { 99, 99 } },
  { {  0,  0 }, { 63, 31 }, { 63,  0 }, { 99, 99 } },
  { {  0,  0 }, {  3, 63 }, {  3,  0 }, { 99, 99 } },
  { {  0,  0 }, {  7, 63 }, {  7,  0 }, { 99, 99 } },
  { {  0,  0 }, { 15, 63 }, { 15,  0 }, { 99, 99 } },
  { {  0,  0 }, { 31, 63 }, { 31,  0 }, { 99, 99 } },
  { {  0,  0 }, { 63, 63 }, { 63,  0 }, { 99, 99 } },
  { {  3,  0 }, {  3,  3 }, {  0,  0 }, {  0,  3 } },
  { {  7,  0 }, {  7,  3 }, {  0,  0 }, {  0,  3 } },
  { { 15,  0 }, { 15,  3 }, {  0,  0 }, {  0,  3 } },
  { { 31,  0 }, { 31,  3 }, {  0,  0 }, {  0,  3 } },
  { { 63,  0 }, { 63,  3 }, {  0,  0 }, {  0,  3 } },
  { {  3,  0 }, {  3,  7 }, {  0,  0 }, {  0,  7 } },
  { {  7,  0 }, {  7,  7 }, {  0,  0 }, {  0,  7 } },
  { { 15,  0 }, { 15,  7 }, {  0,  0 }, {  0,  7 } },
  { { 31,  0 }, { 31,  7 }, {  0,  0 }, {  0,  7 } },
  { { 63,  0 }, { 63,  7 }, {  0,  0 }, {  0,  7 } },
  { {  3,  0 }, {  3, 15 }, {  0,  0 }, {  0, 15 } },
  { {  7,  0 }, {  7, 15 }, {  0,  0 }, {  0, 15 } },
  { { 15,  0 }, { 15, 15 }, {  0,  0 }, {  0, 15 } },
  { { 31,  0 }, { 31, 15 }, {  0,  0 }, {  0, 15 } },
  { { 63,  0 }, { 63, 15 }, {  0,  0 }, {  0, 15 } },
  { {  3,  0 }, {  3, 31 }, {  0,  0 }, {  0, 31 } },
  { {  7,  0 }, {  7, 31 }, {  0,  0 }, {  0, 31 } },
  { { 15,  0 }, { 15, 31 }, {  0,  0 }, {  0, 31 } },
  { { 31,  0 }, { 31, 31 }, {  0,  0 }, {  0, 31 } },
  { { 63,  0 }, { 63, 31 }, {  0,  0 }, {  0, 31 } },
  { {  3,  0 }, {  3, 63 }, {  0,  0 }, {  0, 63 } },
  { {  7,  0 }, {  7, 63 }, {  0,  0 }, {  0, 63 } },
  { { 15,  0 }, { 15, 63 }, {  0,  0 }, {  0, 63 } },
  { { 31,  0 }, { 31, 63 }, {  0,  0 }, {  0, 63 } },
  { { 63,  0 }, { 63, 63 }, {  0,  0 }, {  0, 63 } },
  { {  3,  0 }, {  0,  0 }, {  3,  3 }, {  0,  3 } },
  { {  7,  0 }, {  0,  0 }, {  7,  3 }, {  0,  3 } },
  { { 15,  0 }, {  0,  0 }, { 15,  3 }, {  0,  3 } },
  { { 31,  0 }, {  0,  0 }, { 31,  3 }, {  0,  3 } },
  { { 63,  0 }, {  0,  0 }, { 63,  3 }, {  0,  3 } },
  { {  3,  0 }, {  0,  0 }, {  3,  7 }, {  0,  7 } },
  { {  7,  0 }, {  0,  0 }, {  7,  7 }, {  0,  7 } },
  { { 15,  0 }, {  0,  0 }, { 15,  7 }, {  0,  7 } },
  { { 31,  0 }, {  0,  0 }, { 31,  7 }, {  0,  7 } },
  { { 63,  0 }, {  0,  0 }, { 63,  7 }, {  0,  7 } },
  { {  3,  0 }, {  0,  0 }, {  3, 15 }, {  0, 15 } },
  { {  7,  0 }, {  0,  0 }, {  7, 15 }, {  0, 15 } },
  { { 15,  0 }, {  0,  0 }, { 15, 15 }, {  0, 15 } },
  { { 31,  0 }, {  0,  0 }, { 31, 15 }, {  0, 15 } },
  { { 63,  0 }, {  0,  0 }, { 63, 15 }, {  0, 15 } },
  { {  3,  0 }, {  0,  0 }, {  3, 31 }, {  0, 31 } },
  { {  7,  0 }, {  0,  0 }, {  7, 31 }, {  0, 31 } },
  { { 15,  0 }, {  0,  0 }, { 15, 31 }, {  0, 31 } },
  { { 31,  0 }, {  0,  0 }, { 31, 31 }, {  0, 31 } },
  { { 63,  0 }, {  0,  0 }, { 63, 31 }, {  0, 31 } },
  { {  3,  0 }, {  0,  0 }, {  3, 63 }, {  0, 63 } },
  { {  7,  0 }, {  0,  0 }, {  7, 63 }, {  0, 63 } },
  { { 15,  0 }, {  0,  0 }, { 15, 63 }, {  0, 63 } },
  { { 31,  0 }, {  0,  0 }, { 31, 63 }, {  0, 63 } },
  { { 63,  0 }, {  0,  0 }, { 63, 63 }, {  0, 63 } },
  { {  3,  3 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  7,  3 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { { 15,  3 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { { 31,  3 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { { 63,  3 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  3,  7 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  7,  7 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { { 15,  7 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { { 31,  7 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { { 63,  7 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  3, 15 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  7, 15 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { { 15, 15 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { { 31, 15 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { { 63, 15 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  3, 31 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  7, 31 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { { 15, 31 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { { 31, 31 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { { 63, 31 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  3, 63 }, {  0,  0 }, {  3,  0 }, { 99, 99 } },
  { {  7, 63 }, {  0,  0 }, {  7,  0 }, { 99, 99 } },
  { { 15, 63 }, {  0,  0 }, { 15,  0 }, { 99, 99 } },
  { { 31, 63 }, {  0,  0 }, { 31,  0 }, { 99, 99 } },
  { { 63, 63 }, {  0,  0 }, { 63,  0 }, { 99, 99 } },
  { {  3,  3 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  7,  3 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { { 15,  3 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { { 31,  3 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { { 63,  3 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  3,  7 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  7,  7 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { { 15,  7 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { { 31,  7 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { { 63,  7 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  3, 15 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  7, 15 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { { 15, 15 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { { 31, 15 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { { 63, 15 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  3, 31 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  7, 31 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { { 15, 31 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { { 31, 31 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { { 63, 31 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  3, 63 }, {  3,  0 }, {  0,  0 }, { 99, 99 } },
  { {  7, 63 }, {  7,  0 }, {  0,  0 }, { 99, 99 } },
  { { 15, 63 }, { 15,  0 }, {  0,  0 }, { 99, 99 } },
  { { 31, 63 }, { 31,  0 }, {  0,  0 }, { 99, 99 } },
  { { 63, 63 }, { 63,  0 }, {  0,  0 }, { 99, 99 } },
  { {  3,  0 }, {  3,  3 }, {  0,  3 }, { 99, 99 } },
  { {  7,  0 }, {  7,  3 }, {  0,  3 }, { 99, 99 } },
  { { 15,  0 }, { 15,  3 }, {  0,  3 }, { 99, 99 } },
  { { 31,  0 }, { 31,  3 }, {  0,  3 }, { 99, 99 } },
  { { 63,  0 }, { 63,  3 }, {  0,  3 }, { 99, 99 } },
  { {  3,  0 }, {  3,  7 }, {  0,  7 }, { 99, 99 } },
  { {  7,  0 }, {  7,  7 }, {  0,  7 }, { 99, 99 } },
  { { 15,  0 }, { 15,  7 }, {  0,  7 }, { 99, 99 } },
  { { 31,  0 }, { 31,  7 }, {  0,  7 }, { 99, 99 } },
  { { 63,  0 }, { 63,  7 }, {  0,  7 }, { 99, 99 } },
  { {  3,  0 }, {  3, 15 }, {  0, 15 }, { 99, 99 } },
  { {  7,  0 }, {  7, 15 }, {  0, 15 }, { 99, 99 } },
  { { 15,  0 }, { 15, 15 }, {  0, 15 }, { 99, 99 } },
  { { 31,  0 }, { 31, 15 }, {  0, 15 }, { 99, 99 } },
  { { 63,  0 }, { 63, 15 }, {  0, 15 }, { 99, 99 } },
  { {  3,  0 }, {  3, 31 }, {  0, 31 }, { 99, 99 } },
  { {  7,  0 }, {  7, 31 }, {  0, 31 }, { 99, 99 } },
  { { 15,  0 }, { 15, 31 }, {  0, 31 }, { 99, 99 } },
  { { 31,  0 }, { 31, 31 }, {  0, 31 }, { 99, 99 } },
  { { 63,  0 }, { 63, 31 }, {  0, 31 }, { 99, 99 } },
  { {  3,  0 }, {  3, 63 }, {  0, 63 }, { 99, 99 } },
  { {  7,  0 }, {  7, 63 }, {  0, 63 }, { 99, 99 } },
  { { 15,  0 }, { 15, 63 }, {  0, 63 }, { 99, 99 } },
  { { 31,  0 }, { 31, 63 }, {  0, 63 }, { 99, 99 } },
  { { 63,  0 }, { 63, 63 }, {  0, 63 }, { 99, 99 } },
  { {  3,  0 }, {  0,  3 }, {  3,  3 }, { 99, 99 } },
  { {  7,  0 }, {  0,  3 }, {  7,  3 }, { 99, 99 } },
  { { 15,  0 }, {  0,  3 }, { 15,  3 }, { 99, 99 } },
  { { 31,  0 }, {  0,  3 }, { 31,  3 }, { 99, 99 } },
  { { 63,  0 }, {  0,  3 }, { 63,  3 }, { 99, 99 } },
  { {  3,  0 }, {  0,  7 }, {  3,  7 }, { 99, 99 } },
  { {  7,  0 }, {  0,  7 }, {  7,  7 }, { 99, 99 } },
  { { 15,  0 }, {  0,  7 }, { 15,  7 }, { 99, 99 } },
  { { 31,  0 }, {  0,  7 }, { 31,  7 }, { 99, 99 } },
  { { 63,  0 }, {  0,  7 }, { 63,  7 }, { 99, 99 } },
  { {  3,  0 }, {  0, 15 }, {  3, 15 }, { 99, 99 } },
  { {  7,  0 }, {  0, 15 }, {  7, 15 }, { 99, 99 } },
  { { 15,  0 }, {  0, 15 }, { 15, 15 }, { 99, 99 } },
  { { 31,  0 }, {  0, 15 }, { 31, 15 }, { 99, 99 } },
  { { 63,  0 }, {  0, 15 }, { 63, 15 }, { 99, 99 } },
  { {  3,  0 }, {  0, 31 }, {  3, 31 }, { 99, 99 } },
  { {  7,  0 }, {  0, 31 }, {  7, 31 }, { 99, 99 } },
  { { 15,  0 }, {  0, 31 }, { 15, 31 }, { 99, 99 } },
  { { 31,  0 }, {  0, 31 }, { 31, 31 }, { 99, 99 } },
  { { 63,  0 }, {  0, 31 }, { 63, 31 }, { 99, 99 } },
  { {  3,  0 }, {  0, 63 }, {  3, 63 }, { 99, 99 } },
  { {  7,  0 }, {  0, 63 }, {  7, 63 }, { 99, 99 } },
  { { 15,  0 }, {  0, 63 }, { 15, 63 }, { 99, 99 } },
  { { 31,  0 }, {  0, 63 }, { 31, 63 }, { 99, 99 } },
  { { 63,  0 }, {  0, 63 }, { 63, 63 }, { 99, 99 } },
  { {  3,  3 }, {  0,  3 }, {  3,  0 }, {  0,  0 } },
  { {  7,  3 }, {  0,  3 }, {  7,  0 }, {  0,  0 } },
  { { 15,  3 }, {  0,  3 }, { 15,  0 }, {  0,  0 } },
  { { 31,  3 }, {  0,  3 }, { 31,  0 }, {  0,  0 } },
  { { 63,  3 }, {  0,  3 }, { 63,  0 }, {  0,  0 } },
  { {  3,  7 }, {  0,  7 }, {  3,  0 }, {  0,  0 } },
  { {  7,  7 }, {  0,  7 }, {  7,  0 }, {  0,  0 } },
  { { 15,  7 }, {  0,  7 }, { 15,  0 }, {  0,  0 } },
  { { 31,  7 }, {  0,  7 }, { 31,  0 }, {  0,  0 } },
  { { 63,  7 }, {  0,  7 }, { 63,  0 }, {  0,  0 } },
  { {  3, 15 }, {  0, 15 }, {  3,  0 }, {  0,  0 } },
  { {  7, 15 }, {  0, 15 }, {  7,  0 }, {  0,  0 } },
  { { 15, 15 }, {  0, 15 }, { 15,  0 }, {  0,  0 } },
  { { 31, 15 }, {  0, 15 }, { 31,  0 }, {  0,  0 } },
  { { 63, 15 }, {  0, 15 }, { 63,  0 }, {  0,  0 } },
  { {  3, 31 }, {  0, 31 }, {  3,  0 }, {  0,  0 } },
  { {  7, 31 }, {  0, 31 }, {  7,  0 }, {  0,  0 } },
  { { 15, 31 }, {  0, 31 }, { 15,  0 }, {  0,  0 } },
  { { 31, 31 }, {  0, 31 }, { 31,  0 }, {  0,  0 } },
  { { 63, 31 }, {  0, 31 }, { 63,  0 }, {  0,  0 } },
  { {  3, 63 }, {  0, 63 }, {  3,  0 }, {  0,  0 } },
  { {  7, 63 }, {  0, 63 }, {  7,  0 }, {  0,  0 } },
  { { 15, 63 }, {  0, 63 }, {  0,  0 }, {  0,  0 } },
  { { 31, 63 }, {  0, 63 }, { 31,  0 }, {  0,  0 } },
  { { 63, 63 }, {  0, 63 }, { 63,  0 }, {  0,  0 } },
  { {  3,  3 }, {  3,  0 }, {  0,  3 }, {  0,  0 } },
  { {  7,  3 }, {  7,  0 }, {  0,  3 }, {  0,  0 } },
  { { 15,  3 }, { 15,  0 }, {  0,  3 }, {  0,  0 } },
  { { 31,  3 }, { 31,  0 }, {  0,  3 }, {  0,  0 } },
  { { 63,  3 }, { 63,  0 }, {  0,  3 }, {  0,  0 } },
  { {  3,  7 }, {  3,  0 }, {  0,  7 }, {  0,  0 } },
  { {  7,  7 }, {  7,  0 }, {  0,  7 }, {  0,  0 } },
  { { 15,  7 }, { 15,  0 }, {  0,  7 }, {  0,  0 } },
  { { 31,  7 }, { 31,  0 }, {  0,  7 }, {  0,  0 } },
  { { 63,  7 }, { 63,  0 }, {  0,  7 }, {  0,  0 } },
  { {  3, 15 }, {  3,  0 }, {  0, 15 }, {  0,  0 } },
  { {  7, 15 }, {  7,  0 }, {  0, 15 }, {  0,  0 } },
  { { 15, 15 }, { 15,  0 }, {  0, 15 }, {  0,  0 } },
  { { 31, 15 }, { 31,  0 }, {  0, 15 }, {  0,  0 } },
  { { 63, 15 }, { 63,  0 }, {  0, 15 }, {  0,  0 } },
  { {  3, 31 }, {  3,  0 }, {  0, 31 }, {  0,  0 } },
  { {  7, 31 }, {  7,  0 }, {  0, 31 }, {  0,  0 } },
  { { 15, 31 }, { 15,  0 }, {  0, 31 }, {  0,  0 } },
  { { 31, 31 }, { 31,  0 }, {  0, 31 }, {  0,  0 } },
  { { 63, 31 }, { 63,  0 }, {  0, 31 }, {  0,  0 } },
  { {  3, 63 }, {  3,  0 }, {  0, 63 }, {  0,  0 } },
  { {  7, 63 }, {  7,  0 }, {  0, 63 }, {  0,  0 } },
  { { 15, 63 }, { 15,  0 }, {  0, 63 }, {  0,  0 } },
  { { 31, 63 }, { 31,  0 }, {  0, 63 }, {  0,  0 } },
  { { 63, 63 }, { 63,  0 }, {  0, 63 }, {  0,  0 } },
  { {  0,  3 }, {  3,  0 }, {  3,  3 }, { 99, 99 } },
  { {  0,  3 }, {  7,  0 }, {  7,  3 }, { 99, 99 } },
  { {  0,  3 }, { 15,  0 }, { 15,  3 }, { 99, 99 } },
  { {  0,  3 }, { 31,  0 }, { 31,  3 }, { 99, 99 } },
  { {  0,  3 }, { 63,  0 }, { 63,  3 }, { 99, 99 } },
  { {  0,  7 }, {  3,  0 }, {  3,  7 }, { 99, 99 } },
  { {  0,  7 }, {  7,  0 }, {  7,  7 }, { 99, 99 } },
  { {  0,  7 }, { 15,  0 }, { 15,  7 }, { 99, 99 } },
  { {  0,  7 }, { 31,  0 }, { 31,  7 }, { 99, 99 } },
  { {  0,  7 }, { 63,  0 }, { 63,  7 }, { 99, 99 } },
  { {  0, 15 }, {  3,  0 }, {  3, 15 }, { 99, 99 } },
  { {  0, 15 }, {  7,  0 }, {  7, 15 }, { 99, 99 } },
  { {  0, 15 }, { 15,  0 }, { 15, 15 }, { 99, 99 } },
  { {  0, 15 }, { 31,  0 }, { 31, 15 }, { 99, 99 } },
  { {  0, 15 }, { 63,  0 }, { 63, 15 }, { 99, 99 } },
  { {  0, 31 }, {  3,  0 }, {  3, 31 }, { 99, 99 } },
  { {  0, 31 }, {  7,  0 }, {  7, 31 }, { 99, 99 } },
  { {  0, 31 }, { 15,  0 }, { 15, 31 }, { 99, 99 } },
  { {  0, 31 }, { 31,  0 }, { 31, 31 }, { 99, 99 } },
  { {  0, 31 }, { 63,  0 }, { 63, 31 }, { 99, 99 } },
  { {  0, 63 }, {  3,  0 }, {  3, 63 }, { 99, 99 } },
  { {  0, 63 }, {  7,  0 }, {  7, 63 }, { 99, 99 } },
  { {  0, 63 }, { 15,  0 }, { 15, 63 }, { 99, 99 } },
  { {  0, 63 }, { 31,  0 }, { 31, 63 }, { 99, 99 } },
  { {  0, 63 }, { 63,  0 }, { 63, 63 }, { 99, 99 } },
  { {  0,  3 }, {  3,  3 }, {  3,  0 }, { 99, 99 } },
  { {  0,  3 }, {  7,  3 }, {  7,  0 }, { 99, 99 } },
  { {  0,  3 }, { 15,  3 }, { 15,  0 }, { 99, 99 } },
  { {  0,  3 }, { 31,  3 }, { 31,  0 }, { 99, 99 } },
  { {  0,  3 }, { 63,  3 }, { 63,  0 }, { 99, 99 } },
  { {  0,  7 }, {  3,  7 }, {  3,  0 }, { 99, 99 } },
  { {  0,  7 }, {  7,  7 }, {  7,  0 }, { 99, 99 } },
  { {  0,  7 }, { 15,  7 }, { 15,  0 }, { 99, 99 } },
  { {  0,  7 }, { 31,  7 }, { 31,  0 }, { 99, 99 } },
  { {  0,  7 }, { 63,  7 }, { 63,  0 }, { 99, 99 } },
  { {  0, 15 }, {  3, 15 }, {  3,  0 }, { 99, 99 } },
  { {  0, 15 }, {  7, 15 }, {  7,  0 }, { 99, 99 } },
  { {  0, 15 }, { 15, 15 }, { 15,  0 }, { 99, 99 } },
  { {  0, 15 }, { 31, 15 }, { 31,  0 }, { 99, 99 } },
  { {  0, 15 }, { 63, 15 }, { 63,  0 }, { 99, 99 } },
  { {  0, 31 }, {  3, 31 }, {  3,  0 }, { 99, 99 } },
  { {  0, 31 }, {  7, 31 }, {  7,  0 }, { 99, 99 } },
  { {  0, 31 }, { 15, 31 }, { 15,  0 }, { 99, 99 } },
  { {  0, 31 }, { 31, 31 }, { 31,  0 }, { 99, 99 } },
  { {  0, 31 }, { 63, 31 }, { 63,  0 }, { 99, 99 } },
  { {  0, 63 }, {  3, 63 }, {  3,  0 }, { 99, 99 } },
  { {  0, 63 }, {  7, 63 }, {  7,  0 }, { 99, 99 } },
  { {  0, 63 }, { 15, 63 }, { 15,  0 }, { 99, 99 } },
  { {  0, 63 }, { 31, 63 }, { 31,  0 }, { 99, 99 } },
  { {  0, 63 }, { 63, 63 }, { 63,  0 }, { 99, 99 } },
  { {  0,  0 }, {  3,  3 }, {  0,  3 }, { 99, 99 } },
  { {  0,  0 }, {  7,  3 }, {  0,  3 }, { 99, 99 } },
  { {  0,  0 }, { 15,  3 }, {  0,  3 }, { 99, 99 } },
  { {  0,  0 }, { 31,  3 }, {  0,  3 }, { 99, 99 } },
  { {  0,  0 }, { 63,  3 }, {  0,  3 }, { 99, 99 } },
  { {  0,  0 }, {  3,  7 }, {  0,  7 }, { 99, 99 } },
  { {  0,  0 }, {  7,  7 }, {  0,  7 }, { 99, 99 } },
  { {  0,  0 }, { 15,  7 }, {  0,  7 }, { 99, 99 } },
  { {  0,  0 }, { 31,  7 }, {  0,  7 }, { 99, 99 } },
  { {  0,  0 }, { 63,  7 }, {  0,  7 }, { 99, 99 } },
  { {  0,  0 }, {  3, 15 }, {  0, 15 }, { 99, 99 } },
  { {  0,  0 }, {  7, 15 }, {  0, 15 }, { 99, 99 } },
  { {  0,  0 }, { 15, 15 }, {  0, 15 }, { 99, 99 } },
  { {  0,  0 }, { 31, 15 }, {  0, 15 }, { 99, 99 } },
  { {  0,  0 }, { 63, 15 }, {  0, 15 }, { 99, 99 } },
  { {  0,  0 }, {  3, 31 }, {  0, 31 }, { 99, 99 } },
  { {  0,  0 }, {  7, 31 }, {  0, 31 }, { 99, 99 } },
  { {  0,  0 }, { 15, 31 }, {  0, 31 }, { 99, 99 } },
  { {  0,  0 }, { 31, 31 }, {  0, 31 }, { 99, 99 } },
  { {  0,  0 }, { 63, 31 }, {  0, 31 }, { 99, 99 } },
  { {  0,  0 }, {  3, 63 }, {  0, 63 }, { 99, 99 } },
  { {  0,  0 }, {  7, 63 }, {  0, 63 }, { 99, 99 } },
  { {  0,  0 }, { 15, 63 }, {  0, 63 }, { 99, 99 } },
  { {  0,  0 }, { 31, 63 }, {  0, 63 }, { 99, 99 } },
  { {  0,  0 }, { 63, 63 }, {  0, 63 }, { 99, 99 } },
  { {  0,  0 }, {  0,  3 }, {  3,  3 }, { 99, 99 } },
  { {  0,  0 }, {  0,  3 }, {  7,  3 }, { 99, 99 } },
  { {  0,  0 }, {  0,  3 }, { 15,  3 }, { 99, 99 } },
  { {  0,  0 }, {  0,  3 }, { 31,  3 }, { 99, 99 } },
  { {  0,  0 }, {  0,  3 }, { 63,  3 }, { 99, 99 } },
  { {  0,  0 }, {  0,  7 }, {  3,  7 }, { 99, 99 } },
  { {  0,  0 }, {  0,  7 }, {  7,  7 }, { 99, 99 } },
  { {  0,  0 }, {  0,  7 }, { 15,  7 }, { 99, 99 } },
  { {  0,  0 }, {  0,  7 }, { 31,  7 }, { 99, 99 } },
  { {  0,  0 }, {  0,  7 }, { 63,  7 }, { 99, 99 } },
  { {  0,  0 }, {  0, 15 }, {  3, 15 }, { 99, 99 } },
  { {  0,  0 }, {  0, 15 }, {  7, 15 }, { 99, 99 } },
  { {  0,  0 }, {  0, 15 }, { 15, 15 }, { 99, 99 } },
  { {  0,  0 }, {  0, 15 }, { 31, 15 }, { 99, 99 } },
  { {  0,  0 }, {  0, 15 }, { 63, 15 }, { 99, 99 } },
  { {  0,  0 }, {  0, 31 }, {  3, 31 }, { 99, 99 } },
  { {  0,  0 }, {  0, 31 }, {  7, 31 }, { 99, 99 } },
  { {  0,  0 }, {  0, 31 }, { 15, 31 }, { 99, 99 } },
  { {  0,  0 }, {  0, 31 }, { 31, 31 }, { 99, 99 } },
  { {  0,  0 }, {  0, 31 }, { 63, 31 }, { 99, 99 } },
  { {  0,  0 }, {  0, 63 }, {  3, 63 }, { 99, 99 } },
  { {  0,  0 }, {  0, 63 }, {  7, 63 }, { 99, 99 } },
  { {  0,  0 }, {  0, 63 }, { 15, 63 }, { 99, 99 } },
  { {  0,  0 }, {  0, 63 }, { 31, 63 }, { 99, 99 } },
  { {  0,  0 }, {  0, 63 }, { 63, 63 }, { 99, 99 } },
  { {  3,  3 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { {  7,  3 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { { 15,  3 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { { 31,  3 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { { 63,  3 }, {  0,  3 }, {  0,  0 }, { 99, 99 } },
  { {  3,  7 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { {  7,  7 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { { 15,  7 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { { 31,  7 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { { 63,  7 }, {  0,  7 }, {  0,  0 }, { 99, 99 } },
  { {  3, 15 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { {  7, 15 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { { 15, 15 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { { 31, 15 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { { 63, 15 }, {  0, 15 }, {  0,  0 }, { 99, 99 } },
  { {  3, 31 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { {  7, 31 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { { 15, 31 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { { 31, 31 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { { 63, 31 }, {  0, 31 }, {  0,  0 }, { 99, 99 } },
  { {  3, 63 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { {  7, 63 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { { 15, 63 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { { 31, 63 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { { 63, 63 }, {  0, 63 }, {  0,  0 }, { 99, 99 } },
  { {  3,  3 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { {  7,  3 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { { 15,  3 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { { 31,  3 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { { 63,  3 }, {  0,  0 }, {  0,  3 }, { 99, 99 } },
  { {  3,  7 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { {  7,  7 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { { 15,  7 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { { 31,  7 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { { 63,  7 }, {  0,  0 }, {  0,  7 }, { 99, 99 } },
  { {  3, 15 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { {  7, 15 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { { 15, 15 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { { 31, 15 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { { 63, 15 }, {  0,  0 }, {  0, 15 }, { 99, 99 } },
  { {  3, 31 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { {  7, 31 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { { 15, 31 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { { 31, 31 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { { 63, 31 }, {  0,  0 }, {  0, 31 }, { 99, 99 } },
  { {  3, 63 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { {  7, 63 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { { 15, 63 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { { 31, 63 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { { 63, 63 }, {  0,  0 }, {  0, 63 }, { 99, 99 } },
  { {  0,  3 }, {  0,  0 }, {  3,  3 }, {  3,  0 } },
  { {  0,  3 }, {  0,  0 }, {  7,  3 }, {  7,  0 } },
  { {  0,  3 }, {  0,  0 }, { 15,  3 }, { 15,  0 } },
  { {  0,  3 }, {  0,  0 }, { 31,  3 }, { 31,  0 } },
  { {  0,  3 }, {  0,  0 }, { 63,  3 }, { 63,  0 } },
  { {  0,  7 }, {  0,  0 }, {  3,  7 }, {  3,  0 } },
  { {  0,  7 }, {  0,  0 }, {  7,  7 }, {  7,  0 } },
  { {  0,  7 }, {  0,  0 }, { 15,  7 }, { 15,  0 } },
  { {  0,  7 }, {  0,  0 }, { 31,  7 }, { 31,  0 } },
  { {  0,  7 }, {  0,  0 }, { 63,  7 }, { 63,  0 } },
  { {  0, 15 }, {  0,  0 }, {  3, 15 }, {  3,  0 } },
  { {  0, 15 }, {  0,  0 }, {  7, 15 }, {  7,  0 } },
  { {  0, 15 }, {  0,  0 }, { 15, 15 }, { 15,  0 } },
  { {  0, 15 }, {  0,  0 }, { 31, 15 }, { 31,  0 } },
  { {  0, 15 }, {  0,  0 }, { 63, 15 }, { 63,  0 } },
  { {  0, 31 }, {  0,  0 }, {  3, 31 }, {  3,  0 } },
  { {  0, 31 }, {  0,  0 }, {  7, 31 }, {  7,  0 } },
  { {  0, 31 }, {  0,  0 }, { 15, 31 }, { 15,  0 } },
  { {  0, 31 }, {  0,  0 }, { 31, 31 }, { 31,  0 } },
  { {  0, 31 }, {  0,  0 }, { 63, 31 }, { 63,  0 } },
  { {  0, 63 }, {  0,  0 }, {  3, 63 }, {  3,  0 } },
  { {  0, 63 }, {  0,  0 }, {  7, 63 }, {  7,  0 } },
  { {  0, 63 }, {  0,  0 }, { 15, 63 }, { 15,  0 } },
  { {  0, 63 }, {  0,  0 }, { 31, 63 }, { 31,  0 } },
  { {  0, 63 }, {  0,  0 }, { 63, 63 }, { 63,  0 } },
  { {  0,  3 }, {  3,  3 }, {  0,  0 }, {  3,  0 } },
  { {  0,  3 }, {  7,  3 }, {  0,  0 }, {  7,  0 } },
  { {  0,  3 }, { 15,  3 }, {  0,  0 }, { 15,  0 } },
  { {  0,  3 }, { 31,  3 }, {  0,  0 }, { 31,  0 } },
  { {  0,  3 }, { 63,  3 }, {  0,  0 }, { 63,  0 } },
  { {  0,  7 }, {  3,  7 }, {  0,  0 }, {  3,  0 } },
  { {  0,  7 }, {  7,  7 }, {  0,  0 }, {  7,  0 } },
  { {  0,  7 }, { 15,  7 }, {  0,  0 }, { 15,  0 } },
  { {  0,  7 }, { 31,  7 }, {  0,  0 }, { 31,  0 } },
  { {  0,  7 }, { 63,  7 }, {  0,  0 }, { 63,  0 } },
  { {  0, 15 }, {  3, 15 }, {  0,  0 }, {  3,  0 } },
  { {  0, 15 }, {  7, 15 }, {  0,  0 }, {  7,  0 } },
  { {  0, 15 }, { 15, 15 }, {  0,  0 }, { 15,  0 } },
  { {  0, 15 }, { 31, 15 }, {  0,  0 }, { 31,  0 } },
  { {  0, 15 }, { 63, 15 }, {  0,  0 }, { 63,  0 } },
  { {  0, 31 }, {  3, 31 }, {  0,  0 }, {  3,  0 } },
  { {  0, 31 }, {  7, 31 }, {  0,  0 }, {  7,  0 } },
  { {  0, 31 }, { 15, 31 }, {  0,  0 }, { 15,  0 } },
  { {  0, 31 }, { 31, 31 }, {  0,  0 }, { 31,  0 } },
  { {  0, 31 }, { 63, 31 }, {  0,  0 }, { 63,  0 } },
  { {  0, 63 }, {  3, 63 }, {  0,  0 }, {  3,  0 } },
  { {  0, 63 }, {  7, 63 }, {  0,  0 }, {  7,  0 } },
  { {  0, 63 }, { 15, 63 }, {  0,  0 }, { 15,  0 } },
  { {  0, 63 }, { 31, 63 }, {  0,  0 }, { 31,  0 } },
  { {  0, 63 }, { 63, 63 }, {  0,  0 }, { 63,  0 } }
};

/* .bss */
mat16 mn_trans;        /* 8005726C */
mat16 mn_cam_rot;      /* 800577C4 */
mat16 ms_cam_rot;      /* 800577E4 */
mat16 ms_cam_rot2;     /* 80057804 */
mat16 mn_rot;          /* 80057824 */
mat16 ms_rot;          /* 80057844 */
vec cam_trans;         /* 80057864 */
ang cam_rot;           /* 80057870 */
vec cam_scale;         /* 8005787C */
vec cam_trans_prev;    /* 80057888 */
ang cam_rot_prev;      /* 80057894 */
vec cam_scale_prev;    /* 800578A0 */
uint32_t unk_800578AC; /* 800578AC */
vec16 unk_800578B0;    /* 800578B0 */
vec unk_800578B8;      /* 800578B8 */
vec v_unk2;            /* 800578C4 */
uint32_t screen_proj;  /* 800578D0 */
mat16 mn_color;        /* 800578D4 */
mat16 mn_light;        /* 800578F4 */
int32_t tri_wave[16];  /* 800567B8 */

extern int32_t cam_rot_xz;
extern ang cam_rot_after;
extern vec cam_rot_xz_dir;

extern rgb far_color1;
extern int32_t far_t1;
extern rgb far_color2;
extern int32_t far_t2;
extern int dark_shamt_add;
extern int dark_shamt_sub;
extern int dark_amb_fx0;
extern int dark_amb_fx1;
extern int32_t dark_dist;
extern int32_t ripple_speed;
extern int32_t ripple_period;
extern vec dark_illum;

extern int frames_elapsed;
extern int draw_count;

extern int paused;
extern ns_struct ns;
extern gool_object *player;
extern lid_t cur_lid;
extern entry *cur_zone;

//----- (8001767C) --------------------------------------------------------
int TgeoOnLoad(entry *tgeo) {
  tgeo_header *header;
  tgeo_texinfo *info;
  uint8_t *info_p;
  int i;

  header = (tgeo_header*)tgeo->items[0];
  info_p = (uint8_t*)header->texinfos;
  if (cur_lid != LID_TITLE && cur_lid != LID_INTRO) {
    for (i=0;i<header->texinfo_count;i++) {
      info = (tgeo_texinfo*)info_p;
      if (info->type == 1 && (info->tpage & 1))
        info->tpage = (uint32_t)NSProbe(info->tpage); /* TODO: union? */
      info_p += info->type == 1 ? sizeof(tgeo_texinfo) : sizeof(tgeo_colinfo);
    }
  }
  else {
    for (i=0;i<header->texinfo_count;i++) {
      info = (tgeo_texinfo*)info_p;
      if (info->type == 1 && (info->tpage & 1))
        NSOpen(&info->tpage, 0, 1); /* TODO: union? */
      info_p += info->type == 1 ? sizeof(tgeo_texinfo) : sizeof(tgeo_colinfo);
    }
  }
  return SUCCESS;
}

inline static int GfxScreenProj(int fov) {
  switch (fov) {
  case 30: return 960;
  case 37: return 800;
  case 55: return 500;
  case 60: return 460;
  case 90: return 288;
  }
}

//----- (80017790) --------------------------------------------------------
int GfxInitMatrices() {
  GfxResetCam(&cam_trans);
  GfxFillMatrix(&mn_color, 512);
  screen_proj = GfxScreenProj(ns.ldat->fov);
#ifdef PSX
  SetGeomScreen(screen_proj);
  SetGeomOffset(0, 0);
  SetFarColor(0, 0, 0);
  SetColorMatrix(&mn_color);
#else
  params.screen_proj=screen_proj;
  params.screen.x = 0;
  params.screen.y = 0;
  params.far_color.r = 0;
  params.far_color.g = 0;
  params.far_color.b = 0;
  GfxCopyMatrix(&params.m_color, &mn_color);
#endif
  mn_trans.t.x = 0;
  mn_trans.t.y = 0;
  mn_trans.t.z = 0;
  unk_800578B0.x = 0;
  unk_800578B0.y = 0;
  unk_800578B0.z = 4096;
  v_unk2.x = 0;
  v_unk2.y = 0;
  v_unk2.z = 0;
  cam_trans.x = 0;
  cam_trans.y = 0;
  cam_trans.z = 128000;
  cam_rot.y = 0;
  cam_rot.x = 0;
  cam_rot.z = 0;
  cam_trans_prev.x = 0;
  cam_trans_prev.y = 921600;
  cam_trans_prev.z = 6144000;
  unk_800578AC = 0;
  screen_ro.x = 0;
  screen_ro.y = 0;
}

//----- (80017A14) --------------------------------------------------------
void GfxUpdateMatrices() {
  int16_t s, c;
  mat16 m1;
  vec trans;
  mat16_t m, mb;
  zone_header *header;
  rgb8 far_color;
  int32_t y_offs;

  s=sin(-cam_rot.z);
  c=cos(-cam_rot.z);
  m[0][0]=c;m[0][1]=-s;m[0][2]=     0;
  m[1][0]=s;m[1][1]= c;m[1][2]=     0;
  m[2][0]=0;m[2][1]= 0;m[2][2]=0x1000;
  GfxCopyMatrix((mat16*)m, &mn_cam_rot);
  s=sin(-cam_rot.y);
  c=cos(-cam_rot.y);
  m[0][0]=0x1000;m[0][1]=0;m[0][2]= 0;
  m[1][0]=     0;m[1][1]=c;m[1][2]=-s;
  m[2][0]=     0;m[2][1]=s;m[2][2]= c;
  GfxCopyMatrix((mat16*)m, &m1);
#ifdef PSX
  MulMatrix(&mn_cam_rot, &m1);
#else
  SwMulMatrix(&mn_cam_rot, &m1);
#endif
  s = sin(-cam_rot.x);
  c = cos(-cam_rot.x);
  m[0][0]= c;m[0][1]=     0;m[0][2]=s;
  m[1][0]= 0;m[1][1]=0x1000;m[1][2]=0;
  m[2][0]=-s;m[2][1]=     0;m[2][2]=c;
  GfxCopyMatrix((mat16*)m, &m1);
#ifdef PSX
  MulMatrix(&mn_cam_rot, &m1);
#else
  SwMulMatrix(&mn_cam_rot, &m1);
#endif
  header = (zone_header*)cur_zone->items[0];
  far_color = header->far_color;
#ifdef PSX
  SetFarColor(far_color.r, far_color.g, far_color.b);
#else
  params.far_color = far_color;
#endif
  trans.x = cam_trans.x >> 8;
  trans.y = cam_trans.y >> 8;
  trans.z = cam_trans.z >> 8;
#ifdef PSX
  TransMatrix(&mn_cam_rot, t);
#else
  mn_cam_rot.t = trans;
#endif
  /* 5/8 scaled y */
  GfxCopyMatrix(&mn_cam_rot, (mat16*)m);
  mb[0][0]=        m[0][0];mb[0][1]=        m[0][1];mb[0][2]=        m[0][2];
  mb[1][0]=(-5*m[1][0])>>3;mb[1][1]=(-5*m[1][1])>>3;mb[1][2]=(-5*m[1][2])>>3;
  mb[2][0]=       -m[2][0];mb[2][1]=       -m[2][1];mb[2][2]=       -m[2][2];
  GfxCopyMatrix((mat16*)mb, &ms_cam_rot);
  GfxCopyMatrix(&ms_cam_rot, &ms_cam_rot2);
  if (header->flags & 0x1000) {
    /* linearly ramp cam up and down approx. every 4 seconds or 128 draws */
    y_offs = abs(frames_elapsed % 128 - 64)*800;
    cam_trans_prev.y = y_offs + 901600;
    s = sin(125);
    c = cos(125);
    m[0][0]=0x1000;m[0][1]=0;m[0][2]= 0;
    m[1][0]=     0;m[1][1]=c;m[1][2]=-s;
    m[2][0]=     0;m[2][1]=s;m[2][2]= c;
    GfxCopyMatrix((mat16*)m, &mn_rot);
    /*
    mb=&ms_rot.m;
    mb[0][0]=0x1000;mb[0][1]=              0;mb[0][2]=              0;
    mb[1][0]=     0;mb[1][1]=(-5*m[1][1])>>3;mb[1][2]=(-5*m[1][2])>>3;
    mb[2][0]=     0;mb[2][1]=             -s;                      -c;
    */
    m[0][0]=0x1000;m[0][1]=        0;m[0][2]=       0;
    m[1][0]=     0;m[1][1]=(-5*c)>>3;m[1][2]=(5*s)>>3;
    m[2][0]=     0;m[2][1]=       -s;m[2][2]=      -c;
    GfxCopyMatrix((mat16*)m, &ms_rot);
  }
  else {
    mn_rot = mn_cam_rot;
    ms_rot = ms_cam_rot;
  }
#ifdef PSX
  SetGeomOffset(screen_ro.x, screen_ro.y + (screen_shake >> 8));
#else
  params.screen.x = screen_ro.x;
  params.screen.y = screen_ro.y + (screen_shake >> 8);
#endif
  y_offs = screen_shake >> 8;
  screen_shake = (y_offs ? y_offs < 0 ? ~y_offs : 1-y_offs : 0) << 8;
  cam_trans_ro = cam_trans; /* 80061920 */
  cam_rot_ro = cam_rot;     /* 8006192C */
  if (header->flags & 0x1000)
    cam_rot_xz = 0;
  else {
    cam_trans_prev = cam_trans;
    cam_rot_xz = cam_rot_after.x & 0xFFF;
  }
  cam_rot_xz_ro = cam_rot_xz; /* 800618C8 */
  cam_rot_xz_dir.x = sin(cam_rot_xz) >> 4;
  cam_rot_xz_dir.y = 0;
  cam_rot_xz_dir.z = cos(cam_rot_xz) >> 4;
  GfxLoadWorlds(header);
}

//----- (800180A0) --------------------------------------------------------
int GfxResetCam(vec *trans) {
  ang *rot;
  vec *scale;

  rot=(ang*)(trans+1);
  scale=trans+2;
  trans->x=     0;trans->y=     0;trans->z=     0;
  rot->x=       0;rot->y=       0;rot->z=       0;
  scale->x=0x1000;scale->y=0x1000;scale->z=0x1000;
}

// not a separate func
static inline void GfxCalcObjectZoneMatrices(
  gool_object *obj,
  int flag,
  int *zdist,
  vec *r_trans) {
  zone_header *header;
  gool_colors *colors;
  int i,z,val,far;
  int dist,cdist;
  vec trans,*obj_trans,dir,cdir;

  header=(zone_header*)cur_zone->items[0];
  far=header->visibility_depth>>8;
  colors=&obj->colors;
  switch (header->unknown_a) { /* TODO: rename 'unknown_a' to 'shader'? */
  case 2:
    z=limit(r_trans->z-dword_800618B8, 0, 0x7FFF);
    if (z >= 0x7FFF) { return; }

    /* TODO: add calculated z value to 'ambient' zone colors (at 0x318) */
    for (i=0;i<12;i++) {
      val=header->object_colors.l[i];
      val=min(z+val, 0x7FFF);
      colors->l[i]=val;
    }
    for (i=0;i<12;i++) {
      val=header->object_colors.c[i];
      val=min(z+val, 0x1000);
      colors->c[i]=val;
    }
    break;
  case 3:
    if (flag) {
      z=limit((far-dword_800618B8)/4, 0, 28001);
      if (z >= 28001) { return; }
      for (i=0;i<24;i++) {
        val=header->object_colors.a[i];
        val=max(val-z, 0);
        colors->a[i]=val;
      }
    }
    else {
      z=limit((far-dword_800618B8)/200, 0, 8);
      *zdist=z;
    }
    break;
  case 4:
    if (pause_obj)
      trans=pause_obj->vectors.trans;
    else
      trans=player->vectors.trans; /* TODO: player? or crash? */
    obj_trans=&obj->vectors.trans;
    colors->color.r = 0;
    colors->color.g = 0;
    colors->color.b = 0;
    colors->light_mat.v[0].x = 0;
    colors->light_mat.v[0].y = 0;
    colors->light_mat.v[0].z = 0;
    colors->light_mat.v[1].x = 0;
    colors->light_mat.v[1].y = 0;
    colors->light_mat.v[1].z = 0;
    colors->light_mat.v[2].x = 0;
    colors->light_mat.v[2].y = 0;
    colors->light_mat.v[2].z = 0;
    dir.x=(obj_trans->x-trans.x)>>8;
    dir.y=((obj_trans->y-trans.y)>>8)-800;
    dir.z=(obj_trans->z-trans.z)>>8;
    dist=sqrt((dir.x*dir.x)+(dir.y*dir.y)+(dir.z*dir.z));
    if (dark_dist <= 0) { dark_dist=1; }
    dist=max(dist, 1); /* avoid division by 0 */
    dir.x=((trans.x-obj_trans->x)<<8)/dist; /* recalc and normalize */
    dir.y=((trans.y-obj_trans->y)<<8)/dist;
    dir.z=((trans.z-obj_trans->z)<<8)/dist;
    cdist=6000-dist; /* complementary distance */
    cdir.x=((dir.x*cdist)>>8)/dark_dist; /* reversed direction, repositioned 6000 units away */
    cdir.y=((dir.y*cdist)>>8)/dark_dist;
    cdir.z=((dir.z*cdist)>>8)/dark_dist;
    cdir.x=limit(cdir.x, -6000, 6000);
    cdir.y=limit(cdir.y, -6000, 6000);
    cdir.z=limit(cdir.z, -6000, 6000);
    colors->l[0]=cdir.x;colors->l[1]=cdir.y;colors->l[2]=cdir.z;
    colors->l[3]=cdir.x;colors->l[4]=cdir.y;colors->l[5]=cdir.z;
    colors->l[6]=cdir.x;colors->l[7]=cdir.y;colors->l[8]=cdir.z;
    cdist=sqrt((cdir.x*cdir.x)+(cdir.y*cdir.y)+(cdir.z*cdir.z));
    val=cdist/32;
    colors->color.r=val;
    colors->color.g=val;
    colors->color.b=val;
    break;
  }
}

//----- (800180CC) --------------------------------------------------------
int GfxCalcObjectMatrices(svtx_frame *frame, tgeo_header *t_header,
  gool_object *obj, int flag, int32_t *zdist) {
  gool_vectors *vectors;
  gool_colors *colors;
  zone_header *header;
  mat16 m_trans;
  bound2 extents;
  vec u_trans, *r_trans, s_trans, *col;
  int far, code;
  uint32_t status_b;

  r_trans=&m_trans.t;
  vectors=&obj->vectors;
  colors=&obj->colors;
  if (zdist)
    *zdist = 0;
  u_trans.x = (vectors->trans.x - cam_trans_prev.x) >> 8;
  u_trans.y = (vectors->trans.y - cam_trans_prev.y) >> 8;
  u_trans.z = (vectors->trans.z - cam_trans_prev.z) >> 8;
#ifdef PSX
  SetRotMatrix(&ms_rot);
  SetTransMatrix(&mn_trans);
  RotTrans(&u_trans, r_trans, &code);
#else
  SwRotTrans(&u_trans, r_trans, &mn_trans.t, &ms_rot);
#endif
  if (!(cur_display_flags & 0x10000)) {
    header=(zone_header*)cur_zone->items[0];
    far=header->visibility_depth>>8;
    //if (r_trans->z > (far?far:12000)) { return 0; }
    status_b = obj->process.status_b;
    colors = &obj->colors;
    if ((status_b & 0x40000) == 0) {
      if ((int32_t)screen_proj >= r_trans->z) { return 0; }
      if ((status_b & 0x80000000) == 0) {
        s_trans.x=((int32_t)screen_proj*r_trans->x)/r_trans->z;
        s_trans.y=((int32_t)screen_proj*r_trans->y)/r_trans->z;
        //if (abs(s_trans.x)  > 316) { return 0; }
        //if ((s_trans.y+138) > 326) { return 0; }
      }
      else {
        /* weird code in original impl would set col to &frame->col
           for either branch of a check of a4 */
        col=(vec*)&frame->col_x;
#ifdef PSX
        RGteProjectBound(&obj->bound, col, &vectors->trans, &cam_trans_prev);
        extents = scratch.obj_extents;
#else
        SwProjectBound(&obj->bound, col, &vectors->trans, &cam_trans_prev, &extents);
#endif
        //if (extents.p1.x < -256 && extents.p2.x < -256) { return 0; }
        //if (extents.p1.x >  256 && extents.p2.x >  256) { return 0; }
        //if (extents.p1.y < -108 && extents.p2.y < -108) { return 0; }
        //if (extents.p1.y >  108 && extents.p2.y >  108) { return 0; }
      }
    }
    if (obj && (status_b & 0x400))
      GfxCalcObjectZoneMatrices(obj, flag, zdist, r_trans);
  }
#ifdef PSX
  if (flag)
    RGteCalcObjectMatrices(mn_rot, t_header, vectors, colors);
  else
    RGteCalcObjectRotMatrix(mn_rot, t_header, vectors);
  SetTransMatrix(m_trans);
#else
  if (flag)
    SwCalcObjectMatrices(&mn_rot, t_header, vectors, colors, &params);
  else
    SwCalcObjectRotMatrix(&mn_rot, t_header, vectors, &params);
  params.trans = m_trans.t;
#endif
  return 1;
}

//----- (80018964) --------------------------------------------------------
void GfxTransformSvtx(svtx_frame *frame, void *ot, gool_object *obj) {
  entry *tgeo; // $s2
  tgeo_header *header; // $s3
  tgeo_polygon *polys;
  void **prims_tail;
  int res; // $v0

  tgeo = NSLookup(&frame->tgeo);
  header = (tgeo_header*)tgeo->items[0];
  polys = (tgeo_polygon*)tgeo->items[1];
  res = GfxCalcObjectMatrices(frame, header, obj, 1, 0);
  if (res) {
#ifdef PSX
    prims_tail = GpuGetPrimsTail();
    RGteTransformSvtx(
      frame,
      ot,
      polys,
      header,
      obj->scale.x,
      obj->size + 0x800-(screen_proj/2),
      prims_tail,
      (rect28*)uv_map);
#else
    prims_tail = GLGetPrimsTail();
    SwTransformSvtx(
      frame,
      ot,
      polys,
      header,
      obj->scale.x,
      obj->size + 0x800-(screen_proj/2),
      prims_tail,
      (rect28*)uv_map,
      1,
      &params);
#endif
  }
}

//----- (80018A40) --------------------------------------------------------
void GfxTransformCvtx(cvtx_frame *frame, void *ot, gool_object *obj) {
  entry *tgeo; // $s3
  zone_header *z_header;
  tgeo_header *header; // $s2
  tgeo_polygon *polys;
  void **prims_tail; // $v0
  int res, z_dist; // $v0

  tgeo = NSLookup(&frame->tgeo);
  header = (tgeo_header*)tgeo->items[0];
  polys = (tgeo_polygon*)tgeo->items[1];
  z_dist = 0;
  if (obj->status_b & 0x200) {
    z_header = (zone_header*)cur_zone->items[0];
#ifdef PSX
    res = RGteCalcSpriteRotMatrix(
      obj->vectors,
      (gool_vectors*)&cam_trans_prev,
      1,
      0,
      &ms_rot,
      screen_proj,
      z_header->visibility_depth >> 8);
#else
    res = SwCalcSpriteRotMatrix(
      &obj->vectors,
      (gool_vectors*)&cam_trans_prev,
      1,
      0,
      &ms_rot,
      screen_proj,
      z_header->visibility_depth >> 8,
      &params);
#endif
  }
  else
    res = GfxCalcObjectMatrices((svtx_frame*)frame, header, obj, 0, &z_dist);
  if (res) {
#ifdef PSX
    prims_tail = GpuGetPrimsTail();
    RGteTransformCvtx(
      frame,
      ot,
      polys,
      header,
      obj->scale.x,
      obj->size + 0x800 - (screen_proj/2),
      prims_tail,
      (rect28*)uv_map,
      z_dist);
#else
    prims_tail = GLGetPrimsTail();
    SwTransformCvtx(
      frame,
      ot,
      polys,
      header,
      obj->scale.x,
      obj->size + 0x800 - (screen_proj/2),
      prims_tail,
      (rect28*)uv_map,
      z_dist,
      &params);
#endif
  }
}

#ifdef PSX

//----- (80018B98) --------------------------------------------------------
void GfxTransformFragment(gool_frag *frag, int32_t z,
  tpageinfo pginfo, bound2 *bound, void *ot) {
  /* transform ll, lr, and ul rect verts */
  _$T6 = 0;
  _$A2 = (bound->p2.y << 16) | bound->p1.x;
  __asm {
    mtc2    $a2, $0
    mtc2    $t6, $1
  }
  _$A2 = (bound->p2.y << 16) | bound->p2.x;
  __asm {
    mtc2    $a2, $2
    mtc2    $t6, $3
  }
  _$A2 = (bound->p1.y << 16) | bound->p1.x;
  __asm {
    mtc2    $a2, $4
    mtc2    $t6, $5
    cop2    0x280030
    cfc2    $a2, $31
  }
  if (_$A2 < 0) { return 0; } /* return on fail */
  poly=(POLY_FT4*)context.cur->tail; /* allocate a poly */
  context.cur->tail+=sizeof(POLY_FT4);
  setRGB0(poly,info->r,info->g,info->b)
  code=info.blend_mode==3?0x2C:0x2E;
  setcode(poly,code);
  _$T0=poly;
  __asm {
    mfc2    $a1, $17
    mfc2    $a2, $18
    mfc2    $a3, $19
    swc2    $14, 0x18($t0) /* xy3 */
    swc2    $13, 0x10($t0) /* xy2 */
    swc2    $12, 8($t0)    /* xy1 */
  }
  z_sum=_$A1+_$A2+_$A3;
  $_A2 = (bound->p1.y << 16) | bound->p2.x;
  __asm {
    mtc2    $a2, $0
    mtc2    $t6, $1
    cop2    0x180001
    swc2    $14, 0x20($t0) /* xy4 */
  }
  z_dist=z+(0x800-screen_proj/2);
  z_idx=(z_sum/32)-z_dist;
  z_idx=limit(z_idx, 0, 0x7FF);
  prev=ot[z_idx]; /* grab prev poly at this ot idx */
  setlen(poly, 9);
  catPrim(poly, prev);
  ot[z_idx]=poly;
  /* tail->tag = 0x9000000 | (tail & 0xFFFFFF); */
  info=frag->texinfo;
  color_mode=info.color_mode;
  offs_x=info.offs_x<<(3-color_mode);
  offs_y=info.offs_y<<2|(a3.flag<<7);
  offs_xy=(offs_y<<8)|offs_x;

  poly->clut=(pginfo.yid<<6)|(pginfo.xid<<4)|(colinfo.cluty<<6)|info.clutx;
  poly->tpage=(color_mode<<7)|(info.segment<<5)|(pginfo.yid<<2)|colinfo.semi_trans;
  idx=info.region_idx;
  region=&region_map[idx];
  *(uint16_t*)&poly->u0=region->verts[0]+offs_xy;
  *(uint16_t*)&poly->u1=region->verts[1]+offs_xy;
  *(uint16_t*)&poly->u2=region->verts[2]+offs_xy;
  *(uint16_t*)&poly->u3=region->verts[3]+offs_xy;
}

//----- (80018DBC) --------------------------------------------------------
int GfxTransformFontChar(gool_object *obj, gool_glyph *glyph, int32_t z,
  tpageinfo pginfo, bound2 *bound, void *ot, int gouraud) {
  /*  TODO: asm rewrite  */
  POLY_GT4 *poly,*prev;
  vec *ul,*lr;
  rect16 *region;
  int z_sum,z_dist,z_idx,idx;
  uint32_t tinfo,cinfo,code;
  uint32_t offsx,offsy,offsxy,
  uint32_t color_mode;

  ul=&bound->p1;
  lr=&bound->p2;
  _$T0=(lr->y<<16)|(int16_t)lr->x;
  _$T7=0;
  __asm {
    mtc2    $t0, $0
    mtc2    $t7, $1
  }
  _$T0=(lr->y<<16)|(int16_t)ul->x;
  __asm {
    mtc2    $t0, $2
    mtc2    $t7, $3
  }
  _$T0=(ul->y<<16)|(int16_t)ul->x;
  __asm
  {
    mtc2    $t0, $4
    mtc2    $t7, $5
    cop2    0x280030
    cfc2    $t0, $31
  }
  if (_$T0 < 0) { return 0; }
  poly=(POLY_GT4*)context.cur->tail;
  context.cur->tail+=sizeof(POLY_GT4);
  code=tinfo.blend_mode==3?0x3C:0x3E;
  setcode(poly,code);
  if (gouraud) {
    poly->r0=(color->r*info->colors[0].r)>>8;
    poly->g0=(color->g*info->colors[0].g)>>8;
    poly->b0=(color->b*info->colors[0].b)>>8;
    poly->r1=(color->r*info->colors[1].r)>>8;
    poly->g1=(color->g*info->colors[1].g)>>8;
    poly->b1=(color->b*info->colors[1].b)>>8;
    poly->r2=(color->r*info->colors[2].r)>>8;
    poly->g2=(color->g*info->colors[2].g)>>8;
    poly->b2=(color->b*info->colors[2].b)>>8;
    poly->r3=(color->r*info->colors[3].r)>>8;
    poly->g3=(color->g*info->colors[3].g)>>8;
    poly->b3=(color->b*info->colors[3].b)>>8;
  }
  else {
    setRGB0(poly,color->r,color->g,color->b);
    setRGB1(poly,color->r,color->g,color->b);
    setRGB2(poly,color->r,color->g,color->b);
    setRGB3(poly,color->r,color->g,color->b);
  }
  _$T1 = poly;
  __asm {
    mfc2    $a1, $17
    mfc2    $a2, $18
    mfc2    $a3, $19
    swc2    $14, 0x20($t1) /* xy3 */
    swc2    $13, 0x14($t1) /* xy2 */
    swc2    $12, 8($t1)    /* xy1 */
  }
  z_sum=_$A1+_$A2+_$A3;
  $_T0=(ul->y<<16)|(int16_t)lr->x;
  __asm {
    mtc2    $t0, $0
    mtc2    $t7, $1
    cop2    0x180001
    swc2    $14, 0x2C($t1) /* xy4 */
  }
  z_dist=z+(0x800-screen_proj/2);
  z_idx=(z_sum/32)-z_dist;
  z_idx=limit(z_idx, 0, 0x7FF);
  prev=ot[z_idx]; /* grab prev poly at this ot idx */
  setlen(poly, 12);
  catPrim(poly, prev);
  ot[z_idx]=poly;
  /* poly->tag = 0xC000000 | (poly & 0xFFFFFF); */
  tinfo=chr->texinfo;
  cinfo=chr->clutinfo;
  color_mode=tinfo.color_mode;
  offsx=tinfo.offsx<<(3-color_mode);
  offsy=tinfo.offsy<<2|(pginfo.flag<<7);
  offsxy=(offsy<<8)|offsx;
  poly->clut=(pginfo.yid<<6)|(pginfo.xid<<4)|(cinfo.cluty<<6)|tinfo.clutx;
  poly->tpage=(color_mode<<7)|(tinfo.segment<<5)|(pginfo.yid<<2)|cinfo.semi_trans;
  idx=info.region_idx;
  region=&region_map[idx];
  *(uint16_t*)&poly->u0=region->verts[0]+offs_xy;
  *(uint16_t*)&poly->u1=region->verts[1]+offs_xy;
  *(uint16_t*)&poly->u2=region->verts[2]+offs_xy;
  *(uint16_t*)&poly->u3=region->verts[3]+offs_xy;
}

#else

//----- (80018B98) --------------------------------------------------------
void GfxTransformFragment(gool_frag *frag, int32_t z, eid_t tpag,
  bound2 *bound, void *ot) {
  /* transform ll, lr, and ul rect verts */
  poly4i *prim, *next;
  vec verts[4], r_verts[4];
  fvec uvs[4]; /* corners */
  texinfo info;
  uint32_t z_sum, z_dist;
  void **prims_tail;
  int i, tinf_idx, z_idx, texid;

  verts[0].x=bound->p1.x;verts[0].y=bound->p1.y;
  verts[1].x=bound->p2.x;verts[1].y=bound->p1.y;
  verts[2].x=bound->p1.x;verts[2].y=bound->p2.y;
  verts[3].x=bound->p2.x;verts[3].y=bound->p2.y;
  for (i=0;i<4;i++) {
    verts[i].z = 0;
#ifdef GFX_SW_PERSP
    SwRotTransPers(&verts[i], &r_verts[i], &params.trans, &params.m_rot,
      &params.screen, screen_proj);
#else
    SwRotTrans(&verts[i], &r_verts[i], &params.trans, &params.m_rot);
#endif
  }
  // if (_$A2 < 0) { return 0; } /* return on fail */ // TODO!
  prims_tail=GLGetPrimsTail();
  prim=(poly4i*)(*prims_tail);
  info.colinfo = frag->texinfo.colinfo;
  info.rgninfo = frag->texinfo.rgninfo;
  info.tpage = tpag;
  texid=TextureLoad(&info, &uvs);
  for (i=0;i<4;i++) {
    prim->verts[i]=r_verts[i];
    /*prim->colors[i]=info->rgb;*/
    prim->colors[i]=Rgb8ToA32(info.rgb);
    prim->uvs[i]=uvs[i];
  }
  prim->texid=texid;
  z_sum=prim->verts[0].z+prim->verts[1].z+prim->verts[2].z;
  z_dist=z+(0x800-screen_proj/2); /* far??? */
  z_idx=z_dist-(z_sum/32);
  z_idx=limit(z_idx, 0, 0x7FF);
  next=((poly4i**)ot)[z_idx];
  prim->next=next;
  prim->type=2;
  ((poly4i**)ot)[z_idx]=prim;
  *prims_tail+=sizeof(poly4i);
}

//----- (80018DBC) --------------------------------------------------------
void GfxTransformFontChar(gool_object *obj, gool_glyph *glyph, int32_t z,
  eid_t tpag, bound2 *bound, void *ot, int gouraud) {
  poly4i *prim, *next;
  vec verts[4], r_verts[4];
  fvec uvs[4];
  texinfo info;
  rgb8 rgb;
  int32_t z_sum, z_dist;
  void **prims_tail;
  int i, idx, z_idx, texid;

  verts[2].x=bound->p1.x;verts[2].y=bound->p1.y;
  verts[3].x=bound->p2.x;verts[3].y=bound->p1.y;
  verts[0].x=bound->p1.x;verts[0].y=bound->p2.y;
  verts[1].x=bound->p2.x;verts[1].y=bound->p2.y;
  for (i=0;i<4;i++) {
    verts[i].z = 0;
#ifdef GFX_SW_PERSP
    SwRotTransPers(&verts[i], &r_verts[i], &params.trans, &params.m_rot,
      &params.screen, screen_proj);
#else
    SwRotTrans(&verts[i], &r_verts[i], &params.trans, &params.m_rot);
#endif
  }
  // if (_$T0 < 0) { return 0; } /* return on fail */ // TODO!
  prims_tail=GLGetPrimsTail();
  prim=(poly4i*)*prims_tail;
  info.colinfo = glyph->texinfo.colinfo;
  info.rgninfo = glyph->texinfo.rgninfo;
  info.tpage = tpag;
  texid=TextureLoad(&info, &uvs);
  for (i=0;i<4;i++) {
    prim->verts[i]=r_verts[i];
    if (gouraud) {
      rgb.r = (info.r*obj->vert_colors[i].r)>>8;
      rgb.g = (info.g*obj->vert_colors[i].g)>>8;
      rgb.b = (info.b*obj->vert_colors[i].b)>>8;
      prim->colors[i]=Rgb8ToA32(rgb);
    }
    else {
      // prim->colors[i]=info.rgb;
      prim->colors[i]=Rgb8ToA32(info.rgb);
    }
    prim->uvs[i]=uvs[i];
  }
  prim->texid=texid;
  z_sum=prim->verts[0].z+prim->verts[1].z+prim->verts[2].z;
  z_dist=z+(0x800-screen_proj/2); /* far??? */
  z_idx=z_dist-(z_sum/32);
  z_idx=limit(z_idx, 0, 0x7FF);
  next=((poly4i**)ot)[z_idx];
  prim->next=next;
  prim->type=2;
  ((poly4i**)ot)[z_idx]=prim;
  *prims_tail+=sizeof(poly4i);
}

#endif

//----- (80019144) --------------------------------------------------------
void GfxTransform(vec *in, mat16 *mat, vec *out) {
#define m mat->m
  out->x=(m[0][0]*in->x+m[0][1]*in->y+m[0][2]*in->z)>>12;
  out->y=(m[1][0]*in->x+m[1][1]*in->y+m[1][2]*in->z)>>12;
  out->z=(m[2][0]*in->x+m[2][1]*in->y+m[2][2]*in->z)>>12;
#undef m
}

//----- (80018964) --------------------------------------------------------
void GfxLoadWorlds(zone_header *header) {
  zone_world *world;
  wgeo_header *w_header;
  entry *wgeo,*tpag;
  vec trans;
  int i, ii;

  for (i=0;i<header->world_count;i++) {
    world=&header->worlds[i];
    wgeo=NSLookup(&world->eid);
    w_header=(wgeo_header*)wgeo->items[0];
    if (w_header->is_backdrop) {
      world->trans.x=0;
      world->trans.y=0;
      world->trans.z=0;
    }
    else {
      trans.x=w_header->trans_x-(cam_trans.x>>8);
      trans.y=w_header->trans_y-(cam_trans.y>>8);
      trans.z=w_header->trans_z-(cam_trans.z>>8);
      world->trans.x=(ms_cam_rot.m[0][0]*trans.x+ms_cam_rot.m[0][1]*trans.y+ms_cam_rot.m[0][2]*trans.z)>>12;
      world->trans.y=(ms_cam_rot.m[1][0]*trans.x+ms_cam_rot.m[1][1]*trans.y+ms_cam_rot.m[1][2]*trans.z)>>12;
      world->trans.z=(ms_cam_rot.m[2][0]*trans.x+ms_cam_rot.m[2][1]*trans.y+ms_cam_rot.m[2][2]*trans.z)>>12;
    }
    world->header=w_header;
    world->polygons=(wgeo_polygon*)wgeo->items[1];
    world->vertices=(wgeo_vertex*)wgeo->items[2];
    world->texinfos=w_header->texinfos;
    for (ii=0;ii<w_header->tpag_count;ii++) {
      tpag=NSLookup(&w_header->tpags[ii]);
    }
  }
  if (ns.ldat->lid == LID_TITLE && title_state == 15) /* title screen? */
    sub_8001A460(map_level_links, map_key_links); /* do additional stuff */
}

//----- (80019508) --------------------------------------------------------
void GfxTransformWorlds(void *ot) {
  zone_header *header;
  zone_world *worlds;
  void **prims_tail;

  if (!cur_poly_ids->len) { return; }
  header=(zone_header*)cur_zone->items[0];
  worlds=(zone_world*)header->worlds;
#ifdef PSX
  SetRotMatrix(&ms_cam_rot);
  SetLightMatrix(&mn_light);
  size=sizeof(header->worlds);
  RMemcpy((void*)worlds, (void*)scratch.worlds/*0x1F800100*/, size); /* copy worlds to scratch mem */
  prims_tail=GpuGetPrimsTail();
  RGteTransformWorlds(poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,(quad28*)uv_map);
#else
  /* no need to copy worlds or set matrices */
  params.worlds=worlds;
  params.trans=cam_trans;
  params.m_rot=ms_cam_rot;
  params.m_light=mn_light;
  params.far_color1=params.far_color;
  prims_tail=GLGetPrimsTail();
  SwTransformWorlds(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,&params);
#endif
}

//----- (80019AF4) --------------------------------------------------------
static inline void GfxGetFar(int *far, int *shamt) {
  /* exists separately but usage is inlined */
  zone_header *header;
  int lid,visibility_depth;
  int _far,_shamt;

  header=(zone_header*)cur_zone->items[0];
  visibility_depth=header->visibility_depth;
  lid=ns.ldat->lid;
  if (lid == LID_ROADTONOWHERE || lid == LID_THEHIGHROAD) {
    _far=((visibility_depth-(3200*dword_80061898))>>8)-1600;
    _shamt=header->unknown_b;
    dword_800618B8=_far+2000;
  }
  else {
    _far=(visibility_depth>>8)-800;
    _shamt=header->unknown_b;
    if (_shamt)
      _far-=1200;
    dword_800618B8=_far+800;
  }
  *far=_far;
  *shamt=_shamt;
}

//----- (80019BCC) --------------------------------------------------------
void GfxTransformWorldsFog(void *ot) {
  zone_header *header;
  zone_world *worlds,*world;
  wgeo_header *w_header;
  size_t size;
  void **prims_tail;
  int i,far,shamt,val,is_backdrop;

  if (!cur_poly_ids) { return; }
  header=(zone_header*)cur_zone->items[0];
  worlds=header->worlds;
#ifdef PSX
  SetRotMatrix(&ms_cam_rot);
  SetLightMatrix(dword_800578F4);
  size=sizeof(zone_world)*header->world_count;
  RMemcpy((void*)worlds,(void*)scratch.worlds/*0x1F800100*/, size); /* copy worlds to scratch mem */
#else
  /* no need to copy worlds or set matrices */
  params.worlds=worlds;
  params.trans=cam_trans;
  params.m_rot=ms_cam_rot;
  params.m_light=mn_light;
  params.far_color1=params.far_color;
#endif
  GfxGetFar(&far, &shamt);
  for (i=0;i<header->world_count;i++) {
    world=&worlds[i];
    w_header=world->header;
    is_backdrop=w_header->is_backdrop;
    val=is_backdrop?0xFFFF:far;
    world->tag=(shamt<<16)|val; /* tag is unioned with wgeo */
  }
#ifdef PSX
  prims_tail=GpuGetPrimsTail();
  RGteTransformWorldsFog(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,(quad28*)uv_map);
#else
  prims_tail=GLGetPrimsTail();
  SwTransformWorldsFog(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,&params);
#endif
}

//----- (80019DE0) --------------------------------------------------------
void GfxTransformWorldsRipple(void *ot) {
  zone_header *header;
  zone_world *worlds;
  void **prims_tail;
  int i, val;

  /* ripple_speed, ripple_period */
  if (!ot) {
    for (i=0;i<16;i++) {
      val=ripple_period+1>=0?1:8;
      tri_wave[i]=-(ripple_period-((ripple_period+val)/8));
    }
    return;
  }
  if (!cur_poly_ids->len) { return; }
  if (!paused) {
    for (i=0;i<16;i++) {
      tri_wave[i]+=ripple_speed;
      if (tri_wave[i]>ripple_period)
        tri_wave[i]=-(ripple_period-1); /* restart after reaching the peak */
    }
  }
  header=(zone_header*)cur_zone->items[0];
  worlds=header->worlds;
#ifdef PSX
  for (i=0;i<16;i++) {
    // tri_wave[i]=abs(tri_wave[i]);
    scratch.vars[i]=abs(tri_wave[i]); /* scratch.vars will start at 0x1F800048 */
  }
  SetRotMatrix(&ms_cam_rot);
  SetLightMatrix(dword_800578F4);
  header=(zone_header*)cur_zone->items[0];
  RMemcpy((void*)worlds,(void*)scratch.worlds/*0x1F800100*/,256);
  prims_tail=GpuGetPrimsTail();
  RGteTransformWorldsRipple(poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,(quad28*)uv_map);
#else
  for (i=0;i<16;i++)
    params.tri_wave[i] = abs(tri_wave[i]);
  params.worlds=worlds;
  params.trans=cam_trans;
  params.m_rot=ms_cam_rot;
  params.m_light=mn_light;
  params.far_color1=params.far_color;
  prims_tail=GLGetPrimsTail();
  SwTransformWorldsRipple(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,&params);
#endif
}

//----- (80019F90) --------------------------------------------------------
void GfxTransformWorldsLightning(void *ot) {
  zone_header *header;
  zone_world *worlds;
  void **prims_tail;

  if (!cur_poly_ids->len) { return; }
  header=(zone_header*)cur_zone->items[0];
  worlds=header->worlds;
#ifdef PSX
  SetRotMatrix(&ms_cam_rot);
  SetLightMatrix(dword_800578F4);
  RMemcpy((void*)worlds,(void*)scratch.worlds,256);
  scratch.far_color1.r = far_color1.r*16;
  scratch.far_color1.g = far_color1.g*16;
  scratch.far_color1.b = far_color1.b*16;
  scratch.far_t1 = far_t1*16;
  scratch.far_color2.r = far_color2.r*16;
  scratch.far_color2.g = far_color2.g*16;
  scratch.far_color2.b = far_color2.b*16;
  scratch.far_t2 = far_t2*16;
  prims_tail=GpuGetPrimsTail();
  RGteTransformWorldsLightning(poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,(quad28*)uv_map);
#else
  params.worlds=worlds;
  params.trans=cam_trans;
  params.m_rot=ms_cam_rot;
  params.m_light=mn_light;
  params.far_color1.r = far_color1.r*16;
  params.far_color1.g = far_color1.g*16;
  params.far_color1.b = far_color1.b*16;
  params.far_t1 = far_t1*16;
  params.far_color2.r = far_color2.r*16;
  params.far_color2.g = far_color2.g*16;
  params.far_color2.b = far_color2.b*16;
  params.far_t2 = far_t2*16;
  prims_tail=GLGetPrimsTail();
  SwTransformWorldsLightning(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,&params);
#endif
}

//----- (8001A0CC) --------------------------------------------------------
void GfxTransformWorldsDark(void *ot) {
  zone_header *header;
  zone_world *worlds,*world;
  void **prims_tail;
  int32_t far;
  int i,shamt;

  if (!cur_poly_ids->len) { return; }
  header=(zone_header*)cur_zone->items[0];
  worlds=header->worlds;
  GfxGetFar(&far, &shamt);
#ifdef PSX
  SetRotMatrix(&ms_cam_rot);
  SetLightMatrix(&mn_light);
  RMemcpy((void*)worlds,(void*)scratch.worlds,256);
  scratch.far_color1.r = far_color1.r*16;
  scratch.far_color1.g = far_color1.g*16;
  scratch.far_color1.b = far_color1.b*16;
  scratch.far_t1 = far_t1*16;
  scratch.far_color2.r = far_color2.r*16;
  scratch.far_color2.g = far_color2.g*16;
  scratch.far_color2.b = far_color2.b*16;
  scratch.far_t2 = far_t2*16;
  prims_tail=GpuGetPrimsTail();
  RGteTransformWorldsDark(poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,(quad28*)uv_map,far,shamt);
#else
  params.worlds=worlds;
  params.trans=cam_trans;
  params.m_rot=ms_cam_rot;
  params.m_light=mn_light;
  params.far_color1.r = far_color1.r*16;
  params.far_color1.g = far_color1.g*16;
  params.far_color1.b = far_color1.b*16;
  params.far_t1 = far_t1*16;
  params.far_color2.r = far_color2.r*16;
  params.far_color2.g = far_color2.g*16;
  params.far_color2.b = far_color2.b*16;
  params.far_t2 = far_t2*16;
  /* note: psx impl passes these as arguments instead of putting them in the tag */
  for (i=0;i<header->world_count;i++) {
    world=&header->worlds[i];
    world->tag=(shamt<<16)|far; /* tag is unioned with wgeo */
  }
  prims_tail=GLGetPrimsTail();
  SwTransformWorldsDark(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,&params);
#endif
}

//----- (8001A2E0) --------------------------------------------------------
void GfxTransformWorldsDark2(void *ot) {
  zone_header *header;
  zone_world *worlds,*world;
  void **prims_tail,*dst;
  int i;

  if (!cur_poly_ids->len) { return; }
  header=(zone_header*)cur_zone->items[0];
  worlds=header->worlds;
#ifdef PSX
  SetRotMatrix(&ms_cam_rot);
  SetLightMatrix(&mn_light);
  RMemcpy((void*)worlds,(void*)scratch.worlds,256);
  dst=&scratch.polymem;
  for (i=0;i<header->world_count;i++) {
    world=&worlds[i];
    RMemcpy((void*)&world->header->trans_x,(void*)dst,6);
    dst+=16; /* align each dst trans vec to 16 bytes */
  }
  scratch.dark_illum.r=dark_illum.r>>8;
  scratch.dark_illum.g=dark_illum.g>>8;
  scratch.dark_illum.b=dark_illum.b>>8;
  scratch.dark_shamt_add=dark_shamt_add;
  scratch.dark_shamt_sub=dark_shamt_sub;
  scratch.dark_amb_fx0=dark_amb_fx0;
  scratch.dark_amb_fx1=dark_amb_fx1;
  prims_tail=GpuGetPrimsTail();
  RGteTransformWorldsDark2(poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,(quad28*)uv_map);
#else
  params.worlds=header->worlds;
  params.trans=cam_trans;
  params.m_rot=ms_cam_rot;
  params.m_light=mn_light;
  params.illum.x=dark_illum.x>>8;
  params.illum.y=dark_illum.y>>8;
  params.illum.z=dark_illum.z>>8;
  params.shamt_add=dark_shamt_add;
  params.shamt_sub=dark_shamt_sub;
  params.amb_fx0=dark_amb_fx0;
  params.amb_fx1=dark_amb_fx1;
  prims_tail=GLGetPrimsTail();
  SwTransformWorldsDark2(cur_poly_ids,ot,0x800-(screen_proj/2),draw_count,prims_tail,&params);
#endif
}

/*
  item4 for some wgeos seems to group polys by animation
  by specifying a list of 'poly_ids'

  1_______ ________ ________ __gggggg   g = group index
  0_______ iiiiiiii iiiiiiii iiiiiiii   i = group poly 1 index
  0_______ iiiiiiii iiiiiiii iiiiiiii   i = group poly 2 index
  0_______ iiiiiiii iiiiiiii iiiiiiii   ...
  ...
  1_______ ________ ________ __gggggg   g = group index
  0_______ iiiiiiii iiiiiiii iiiiiiii   i = group poly 1 index
  ...

  a maximum of 64 groups is allowed
  flags_a is a bitfield which disables texture animations (holds them at frame 16?) for group i if the i'th bit is set
  flags_b is a bitfield which disables texture animations (holds them at frame 2?) for group i-32 if the i'th bit is set
*/
void sub_8001A460(uint32_t flags_a, uint32_t flags_b) {
  zone_header *header; // $v0
  zone_world *worlds;
  entry *wgeo;
  wgeo_header *w_header;
  wgeo_polygon *polys, *poly;
  poly_id_list *id_list;
  poly_id poly_id;
  uint32_t mask;
  int poly_idx, poly_idx2, bit_idx;
  int i,ii,len;

  header = (zone_header *)cur_zone->items[0];
  worlds = header->worlds;
  for (i=0;i<header->world_count;i++) {
    wgeo = NSLookup(&worlds[i].eid);
    if (wgeo->item_count < 4) { continue; }
    w_header = (wgeo_header*)wgeo->items[0];
    id_list = (poly_id_list*)wgeo->items[3];
    len = id_list->len;
    for (ii=1;ii<len+1;ii++) {
      poly_id = id_list->ids[ii];
      poly_idx = poly_id.poly_idx;
      if (poly_id.flag) {
        poly_idx2 = poly_id.poly_idx;
        continue;
      }
      if (poly_idx >= w_header->poly_count) { continue; }
      polys = (wgeo_polygon*)wgeo->items[1];
      poly = &polys[poly_idx];
      bit_idx = poly_idx2 < 32 ? (1 << poly_idx2) : (1 << (poly_idx2-32));
      mask = (1 << bit_idx);
      if (poly_idx2 < 32) {
        mask = (1 << poly_idx2);
        if (flags_a & mask) {
          poly->anim_phase &= 1;
          poly->anim_phase |= 0xF;
        }
      }
      else {
        mask = (1 << (poly_idx2-32));
        if (flags_b & mask)
          poly->anim_phase &= 1;
      }
    }
  }
}

#ifdef PSX
int __fastcall sub_8001A5F4(int type, uint8_t *icon, int idx, rect2 *rect) {
  texinfo *info;
  uint32_t /*tpageinfo*/pginfo;
  quad28_t *uvs;
  int uv_idx;

  if (icon->type == 2)
    info = &icon[8*(idx>>8)+8];
  else if (icon->type == 5)
    info = &icon[16*(idx>>8)+12];
  pginfo = NSLookup(&icon->ref);
  if (type == 1) {
    uv_idx = info->uv_idx;
    uvs = &uv_map[uv_idx];
    rect->x = (pginfo&0x300)|(((info->segment<<5)|info->offs_x)<<1);
    rect->y = ((pginfo>>10)&0x180)|(info->offs_y<<2);
    rect->w = (uvs[1]->x+1)>>(2-info->color_mode);
    rect->h = uvs[2]->y+1;
  }
  else if (type == 2) {
    rect->x = (pginfo&0x300)|(info->clut_x<<4);
    rect->y = ((pginfo>>10)&0x180)|info->clut_y;
    rect->w = info->color_mode == 0 ? 16 : 256;
    rect->h = 1;
  }
}

void __fastcall sub_8001A754(char *dst, int id, char *src, int len) {
  char *str, c;
  int i, j, idx;

  str = ((uint8_t*)dst)+12;
  idx = id >> 8;
  /* iterate string array; when number of null terms reaches idx
     we have reached the string */
  for (i=0,j=0;j<idx;i++) {
    if (str[i] == 0) { ++j; }
  }
  for (j=0;j<len;j++) { /* copy src to dst string */
    if (*src == 0) { break; }
    c = *src & 0x7F;
    if (c < ' ')  { c = ' '; }
    if (c == '{') { c = '('; }
    if (c == '}') { c = ')'; }
    if (c == '~') { c = '{'; }
    if (c == '%') { c = '}'; }
    str[i+j] = c;
    ++src;
  }
  for (;j<len;j++) { /* pad the remainder with space */
    str[i+j] = ' ';
  }
}

/**
* load or save the texture and clut, described by the texinfo at index idx in the card icon, into/from vram
*
* buf1 is the input/output clut data
* buf2 is the input/output texture data
*/
int __fastcall sub_8001A850(int op, uint8_t *icon, int idx, uint8_t *buf1, uint8_t *buf2) {
  rect2 rect;
  uint8_t __attribute__((aligned(256))) buf[256];
  int i;

  if (buf1) {
    sub_8001A5F4(2, icon, idx, &rect);
    if (op == 1) {
      for (i=0;i<rect.w*rect.h*sizeof(uint16_t);i++)
        buf[i]=buf1[i];
      LoadImage(&rect, buf);
    }
    else {
      StoreImage(&rect, buf);
      DrawSync(0);
      for (i=0;i<rect.w*rect.h*sizeof(uint16_t);i++)
        buf1[i]=buf[i];
    }
  }
  if (buf2) {
    sub_8001A5F4(1, icon, idx, &rect);
    if (op == 1) {
      for (i=0;i<rect.w*rect.h*sizeof(uint16_t);i++)
        buf[i]=buf2[i];
      LoadImage(&rect, buf);
    }
    else {
      StoreImage(&rect, buf);
      DrawSync(0);
      for (i=0;i<rect.w*rect.h*sizeof(uint16_t);i++)
        buf2[i]=buf[i];
    }
  }
}
#endif
